// Modules included in the following assemblies:
//
// * post-installation_configuration/coreos-layering.adoc

:_content-type: PROCEDURE
[id="coreos-layering-on-cluster-applying-new-configs_{context}"]
= Applying new configurations to on-cluster builds

Any opted-in machine config pools must be paused before you can update any machine configs for that pool. The following example uses a machine config file `layered-os-image-override.yaml` that was created for an opted-in machine config pool.

.Prerequisites

. You have a running {product-title} cluster.
. You installed the OpenShift CLI (`oc`).
. You are logged in to the cluster as a user with administrative privileges.
. You have at least one SSH key pair configured either using the `install-config.yaml` file or a machine config file.
. You have access to an image registry and those permissions have been added to the global pull secret.
. You have opted in any machine config pools.

.Procedure

. Pause the machine config pool:
+
[source,terminal]
----
$ oc patch mcp/infra --patch='{"spec": {"paused": true}}' --type=merge
----

. Apply any new configurations:
+
[source,terminal]
----
$ oc apply -f - <<EOF
---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: layered
  name: new-file-layered
spec:
  config:
    ignition:
      config: {}
      security:
        tls: {}
      timeouts: {}
      version: 3.2.0
    storage:
      files:
        - contents:
        ¦   source: data:,hello%20layered%0A
        ¦ mode: 420
        ¦ path: /etc/hello-layered
EOF
----
+
Although the machine config pool is paused, the new machine config gets rendered and the image build still occurs. You can watch for the `machineconfiguration.openshift.io/newestImageEquivalentConfig` annotation to change on the `MachineConfigPool` object to determine if the build completes. You can also watch the logs of the `machine-os-builder` pod in the MCO namespace to determine the same thing.

. Once the build completes, update the `layered-os-image.yaml` file to point to the new {op-system} image:
+
[source,terminal]
----
$ oc patch mc/layered-os-image-override && \
  --patch="$(oc get mcp/layered -o template='{"spec": {"osImageURL": "{{ index .metadata.annotations "machineconfiguration.openshift.io/newestImageEquivalentConfig" }}" } }')" && \ <1>
  --type=merge
----
<1> The machine config `layered-os-image-override.yaml` created for the machine config pool that was opted into layering.

. Unpause the machine config pool:
+
[source,terminal]
----
$ oc patch mcp/infra --patch='{"spec": {"paused": false}}' --type=merge
----
+
[NOTE]
====
The updated image in the `layered-os-image-override.yaml` machine config will roll out with all the machine configs contained within it.
====
