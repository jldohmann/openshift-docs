// Modules included in the following assemblies:
//
// * post-installation_configuration/coreos-layering.adoc

:_content-type: PROCEDURE
[id="coreos-layering-on-cluster-building-images_{context}"]
= Building and rolling out on-cluster custom images

Once a machine config pool has been opted into to on-cluster builds, you need to update any machine configs in this pool to point to the newly built operating system. The following example uses a machine config file `layered-os-image-override.yaml` that was created for an opted-in machine config pool.


.Prerequisites

. You have a running {product-title} cluster.
. You installed the OpenShift CLI (`oc`).
. You are logged in to the cluster as a user with administrative privileges.
. You have at least one SSH key pair configured either using the `install-config.yaml` file or a machine config file.
. You have access to an image registry and those permissions have been added to the global pull secret.
. You have opted in any machine config pools.

.Procedure

. Currently, the `osImageURL` field in the machine config file is set to a tagged image. Update it to point to the new {op-system} image:
+
[source,terminal]
----
$ oc patch mc/layered-os-image-override && \
  --patch="$(oc get mcp/layered -o template='{"spec": {"osImageURL": "{{ index .metadata.annotations "machineconfiguration.openshift.io/newestImageEquivalentConfig" }}" } }')" && \ <1>
  --type=merge
----
<1> The machine config `layered-os-image-override.yaml` for the machine config pool that was opted into layering.
+
[NOTE]
====
This command creates another rendered machine config that starts another on-cluster build. While the node will roll forward to the new rendered config, it only applies what is present within the newly built {op-system} image.
====

. Label a node with the `layered` node role so that the MCO applies the new configuration:
+
[source,terminal]
----
$ oc label node/node-name 'node-role.kubernetes.io/layered='
----
+
This will cordone, drain, and apply the new config.

.Verification
* Verify that the node reboots into the new configuration:
+
[source,terminal]
----
$ oc debug node/node-name -- chroot /host rpm-ostree status
----
